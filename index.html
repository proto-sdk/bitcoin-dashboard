<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="/bitcoin-dashboard/proto_favicon.ico">
    <link rel="icon" type="image/png" href="/bitcoin-dashboard/proto_logo.png">
    <link rel="icon" type="image/png" href="/bitcoin-dashboard/proto_favicon_32.png">
    <link rel="shortcut icon" type="image/x-icon" href="/bitcoin-dashboard/proto_favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Network Statistics</title>
    <style>
        /* ... (keeping existing styles) ... */
        
        /* Interval card specific styles */
        .interval-details {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        .interval-source {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        /* Add animation for updating values */
        @keyframes highlight {
            0% { background-color: rgba(255, 107, 53, 0.2); }
            100% { background-color: transparent; }
        }
        
        .highlight {
            animation: highlight 1s ease-out;
        }
        
        /* Add loading animation */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- ... (keeping existing header and structure) ... -->
    
    <div class="stats-grid">
        <!-- ... (keeping other stat cards) ... -->
        
        <!-- Updated Interval Card -->
        <div class="stat-card" id="intervalCard">
            <div class="status-indicator"></div>
            <span class="stat-icon price-green">⏲️</span>
            <div class="stat-value" id="interval">Loading...</div>
            <div class="stat-label">Block Interval</div>
            <div class="interval-details" id="intervalDetails"></div>
            <div class="interval-source" id="intervalSource"></div>
            <div class="tooltip">Real-time average block interval</div>
        </div>
        
        <!-- ... (keeping other stat cards) ... -->
    </div>

    <!-- ... (keeping footer) ... -->

    <script>
        // Constants
        const TARGET_BLOCK_TIME = 600; // 10 minutes in seconds
        const UPDATE_INTERVAL = 30000; // Update every 30 seconds
        const BLOCKS_TO_AVERAGE = 10; // Number of blocks to calculate average interval
        
        // Store block data
        let lastBlocks = [];
        let lastUpdateTime = 0;
        
        async function fetchBlockInterval() {
            try {
                // Fetch the latest blocks from Blockstream API
                const response = await fetch('https://blockstream.info/api/blocks');
                if (!response.ok) {
                    throw new Error('Failed to fetch blocks');
                }
                
                const blocks = await response.json();
                if (!blocks || blocks.length < 2) {
                    throw new Error('Invalid blocks data');
                }
                
                // Store the blocks data
                lastBlocks = blocks.slice(0, BLOCKS_TO_AVERAGE + 1);
                
                // Calculate intervals between consecutive blocks
                const intervals = [];
                for (let i = 0; i < lastBlocks.length - 1; i++) {
                    const interval = lastBlocks[i].timestamp - lastBlocks[i + 1].timestamp;
                    intervals.push(interval);
                }
                
                // Calculate average interval
                const avgInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;
                
                // Calculate standard deviation
                const variance = intervals.reduce((sum, interval) => {
                    const diff = interval - avgInterval;
                    return sum + diff * diff;
                }, 0) / intervals.length;
                const stdDev = Math.sqrt(variance);
                
                // Update the UI
                const minutes = Math.floor(avgInterval / 60);
                const seconds = Math.floor(avgInterval % 60);
                
                const intervalElement = document.getElementById('interval');
                const newText = `${minutes}m ${seconds}s`;
                
                if (intervalElement.textContent !== newText) {
                    intervalElement.textContent = newText;
                    intervalElement.classList.remove('highlight');
                    void intervalElement.offsetWidth; // Trigger reflow
                    intervalElement.classList.add('highlight');
                }
                
                // Calculate and display deviation from target
                const deviation = ((avgInterval - TARGET_BLOCK_TIME) / TARGET_BLOCK_TIME * 100).toFixed(1);
                const deviationText = deviation > 0 ? `+${deviation}%` : `${deviation}%`;
                
                // Update interval details
                document.getElementById('intervalDetails').textContent = 
                    `${deviationText} from target (10m) • σ=${stdDev.toFixed(1)}s`;
                
                // Update source information
                document.getElementById('intervalSource').textContent = 
                    `Based on last ${BLOCKS_TO_AVERAGE} blocks • Blockstream API`;
                
                // Store the interval for other calculations
                window.currentInterval = avgInterval;
                lastUpdateTime = Date.now();
                
                // Update status indicator
                const statusIndicator = document.querySelector('#intervalCard .status-indicator');
                statusIndicator.style.backgroundColor = '#4CAF50'; // Green for success
                
                return true;
            } catch (error) {
                console.error('Error fetching interval data:', error);
                
                // Update UI to show error state
                document.getElementById('interval').textContent = 'Error';
                document.getElementById('intervalDetails').textContent = 'Failed to fetch interval data';
                document.getElementById('intervalSource').textContent = 'Please try refreshing';
                
                // Update status indicator
                const statusIndicator = document.querySelector('#intervalCard .status-indicator');
                statusIndicator.style.backgroundColor = '#FF6B6B'; // Red for error
                
                return false;
            }
        }
        
        // Update the main fetchData function
        async function fetchData() {
            try {
                // Reset the counter
                startTime = Date.now();
                updateCounter();
                
                // Fetch interval data first
                await fetchBlockInterval();
                
                // ... (rest of the existing fetchData function) ...
                
            } catch (error) {
                console.error('Error in fetchData:', error);
                // ... (existing error handling) ...
            }
        }
        
        // Set up auto-update specifically for interval
        setInterval(async () => {
            if (Date.now() - lastUpdateTime >= UPDATE_INTERVAL) {
                await fetchBlockInterval();
            }
        }, UPDATE_INTERVAL);
        
        // ... (rest of the existing script) ...
    </script>
</body>
</html>
